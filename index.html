<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus UTTOP Connect</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e94560">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CampusPin">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- â”€â”€ Overlay UI principal â”€â”€ -->
    <div id="ui-overlay">
        <div id="info-box">
            <h3>UTTOP Connect</h3>
            <p id="status">DÃ©marrage...</p>
            <div id="user-role" class="badge">--</div>
        </div>

        <!-- BanniÃ¨re hors-ligne -->
        <div id="offline-banner" class="hidden">ğŸ“´ Hors ligne â€” cache utilisÃ©</div>

        <!-- BanniÃ¨re signalements urgents -->
        <div id="urgent-banner" class="hidden">
            <span id="urgent-banner-text"></span>
            <button id="btn-urgent-see">Voir</button>
            <button id="btn-urgent-close" aria-label="Fermer">âœ•</button>
        </div>

        <!-- Bouton "Mes pins" (historique personnel, haut gauche) -->
        <button id="btn-my-pins" title="Mes pins">ğŸ“‹<span id="my-pins-count" class="hidden"></span></button>

        <!-- Indicateur auto-refresh (bas centre) -->
        <div id="refresh-pill" class="hidden">
            <span>â†»</span><span id="refresh-pill-text"></span>
        </div>

        <!-- Bouton ParamÃ¨tres (haut droite) -->
        <button id="btn-settings" title="Personnaliser l'interface">âš™ï¸</button>

        <!-- Bouton : recentrer sur ma position GPS -->
        <button id="btn-locate" title="Recentrer sur ma position">ğŸ¯</button>

        <!-- Bouton : crÃ©er un pin Ã  ma position GPS -->
        <button id="btn-pin-here" title="CrÃ©er un pin ici (ma position)">ğŸ“</button>

        <!-- Bouton SOS -->
        <button id="btn-sos">ğŸš¨ SOS</button>

        <!-- Bouton Recherche (bas centre) -->
        <button id="btn-search" title="Rechercher / Filtrer les pins">ğŸ”</button>

        <!-- BanniÃ¨re mode repositionnement -->
        <div id="reposition-banner" class="hidden">
            ğŸ“ Cliquez sur la carte pour repositionner â€” <strong>Ã‰chap</strong> pour annuler
        </div>

        <!-- Barre mode Ã©dition du layout -->
        <div id="layout-edit-bar" class="hidden">
            <span class="layout-edit-hint">âœ‹ Faites glisser les Ã©lÃ©ments oÃ¹ vous voulez</span>
            <button id="btn-layout-done">âœ“ Terminer</button>
        </div>
    </div>

    <!-- â”€â”€ Carte Leaflet â”€â”€ -->
    <div id="map"></div>

    <!-- â”€â”€ Boussole / Direction â”€â”€ -->
    <div id="compass-overlay" class="hidden" title="Direction vers le pin sÃ©lectionnÃ©">
        <div id="compass-arrow">â†‘</div>
        <div id="compass-dist">--</div>
    </div>

    <!-- â”€â”€ Modale crÃ©ation de pin â”€â”€ -->
    <div id="pin-modal" class="modal hidden">
        <div class="modal-card">
            <h3>Nouveau signalement</h3>
            <form id="pin-form">
                <input type="text" id="pin-title" placeholder="Titre du signalement..." required autocomplete="off">

                <textarea id="pin-description" placeholder="Description (optionnelle)..." rows="2"></textarea>

                <p class="modal-label">CatÃ©gorie</p>
                <div id="cat-grid"></div>

                <!-- â”€â”€ Section camÃ©ra (MediaDevices API) â”€â”€ -->
                <div id="camera-section">
                    <div id="camera-preview-wrap" class="hidden">
                        <video id="camera-video" autoplay playsinline muted></video>
                        <canvas id="camera-canvas" class="hidden"></canvas>
                        <img id="camera-photo" class="hidden" alt="Photo capturÃ©e">
                    </div>
                    <div class="camera-actions">
                        <button type="button" id="btn-open-camera">ğŸ“· Photo</button>
                        <button type="button" id="btn-capture" class="hidden">â¬¤ Capturer</button>
                        <button type="button" id="btn-retake" class="hidden">ğŸ”„ Reprendre</button>
                    </div>
                </div>

                <label class="toggle-row">
                    <span>Partager avec le campus</span>
                    <input type="checkbox" id="toggle-public" checked>
                </label>

                <div class="modal-actions">
                    <button type="button" id="btn-cancel">Annuler</button>
                    <button type="submit" id="btn-submit">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- â”€â”€ Panneau Recherche / Filtrage â”€â”€ -->
    <div id="search-overlay" class="full-overlay hidden">
        <div class="search-panel">
            <div class="search-header">
                <div class="search-input-wrap">
                    <span class="search-prefix">ğŸ”</span>
                    <input type="text" id="search-input" placeholder="Rechercher un pin..." autocomplete="off">
                    <button id="btn-search-close" class="search-close-btn">âœ•</button>
                </div>
                <div id="cat-filters" class="cat-filter-row"></div>
            </div>
            <p id="search-count" class="search-count"></p>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>

    <!-- â”€â”€ Modal Urgences (SOS) â”€â”€ -->
    <div id="sos-overlay" class="full-overlay hidden">
        <div class="sos-sheet">
            <div class="sos-title">ğŸš¨ Urgences</div>
            <p class="sos-sub">Appuyez sur un numÃ©ro pour appeler directement</p>
            <div class="sos-contacts">
                <a href="tel:15"  class="sos-contact"><span class="sos-ico">ğŸ¥</span><div class="sos-contact-info"><strong>SAMU</strong><small>Urgences mÃ©dicales</small></div><span class="sos-num">15</span></a>
                <a href="tel:18"  class="sos-contact"><span class="sos-ico">ğŸš’</span><div class="sos-contact-info"><strong>Pompiers</strong><small>Incendie / Secours</small></div><span class="sos-num">18</span></a>
                <a href="tel:17"  class="sos-contact"><span class="sos-ico">ğŸ‘®</span><div class="sos-contact-info"><strong>Police</strong><small>SÃ©curitÃ© publique</small></div><span class="sos-num">17</span></a>
                <a href="tel:112" class="sos-contact"><span class="sos-ico">ğŸŒ</span><div class="sos-contact-info"><strong>Urgences EU</strong><small>NumÃ©ro europÃ©en</small></div><span class="sos-num">112</span></a>
                <a href="tel:15"  class="sos-contact sos-contact-campus"><span class="sos-ico">ğŸ›ï¸</span><div class="sos-contact-info"><strong>MÃ©decin campus</strong><small>SAMU si urgence</small></div><span class="sos-num">15</span></a>
            </div>
            <div class="sos-position-box">
                <span class="sos-position-label">ğŸ“ Votre position GPS</span>
                <span id="sos-coords">Localisation en coursâ€¦</span>
            </div>
            <button id="btn-sos-close" class="sos-close-btn">Fermer</button>
        </div>
    </div>

    <!-- â”€â”€ Signalement d'un pin â”€â”€ -->
    <div id="report-overlay" class="full-overlay hidden">
        <div class="report-sheet">
            <div class="report-title">âš‘ Signaler ce pin</div>
            <p class="report-sub">Pourquoi souhaitez-vous signaler ce pin ?</p>
            <div class="report-options">
                <label class="report-option"><input type="radio" name="report-reason" value="obsolete"><span>ğŸ• ObsolÃ¨te / problÃ¨me rÃ©solu</span></label>
                <label class="report-option"><input type="radio" name="report-reason" value="location"><span>ğŸ“ Mauvaise localisation</span></label>
                <label class="report-option"><input type="radio" name="report-reason" value="inappropriate"><span>ğŸš« Contenu inappropriÃ©</span></label>
                <label class="report-option"><input type="radio" name="report-reason" value="other"><span>ğŸ’¬ Autre raison</span></label>
            </div>
            <div class="report-actions">
                <button id="report-cancel" class="report-btn-cancel">Annuler</button>
                <button id="report-submit" class="report-btn-submit">Signaler</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Mes pins (historique personnel) â”€â”€ -->
    <div id="my-pins-overlay" class="full-overlay hidden">
        <div class="mypins-panel">
            <div class="mypins-header">
                <span class="mypins-title">ğŸ“‹ Mes pins</span>
                <button id="btn-my-pins-close" class="search-close-btn">âœ•</button>
            </div>
            <div id="my-pins-content" class="mypins-content"></div>
        </div>
    </div>

    <!-- â”€â”€ ParamÃ¨tres / Personnalisation â”€â”€ -->
    <div id="settings-overlay" class="full-overlay hidden">
        <div class="settings-panel">
            <div class="settings-header">
                <span class="settings-title">âš™ï¸ Personnalisation</span>
                <button id="btn-settings-close" class="search-close-btn">âœ•</button>
            </div>
            <div class="settings-content">
                <p class="settings-section-title">VisibilitÃ© des Ã©lÃ©ments</p>
                <label class="settings-row">
                    <span>â„¹ï¸ BoÃ®te d'info</span>
                    <span class="ui-toggle"><input type="checkbox" id="pref-infobox" checked><span class="ui-toggle-track"></span></span>
                </label>
                <label class="settings-row">
                    <span>ğŸš¨ Bouton SOS</span>
                    <span class="ui-toggle"><input type="checkbox" id="pref-sos" checked><span class="ui-toggle-track"></span></span>
                </label>
                <label class="settings-row">
                    <span>ğŸ” Bouton Recherche</span>
                    <span class="ui-toggle"><input type="checkbox" id="pref-search" checked><span class="ui-toggle-track"></span></span>
                </label>
                <label class="settings-row">
                    <span>ğŸ“‹ Mes pins</span>
                    <span class="ui-toggle"><input type="checkbox" id="pref-mypins" checked><span class="ui-toggle-track"></span></span>
                </label>
                <label class="settings-row">
                    <span>ğŸ§­ Boussole</span>
                    <span class="ui-toggle"><input type="checkbox" id="pref-compass" checked><span class="ui-toggle-track"></span></span>
                </label>

                <p class="settings-section-title">Main dominante</p>
                <div class="handedness-row">
                    <button class="handedness-btn active" data-hand="right">ğŸ«± Main droite</button>
                    <button class="handedness-btn" data-hand="left">ğŸ«² Main gauche</button>
                </div>

                <p class="settings-section-title">Disposition</p>
                <button id="btn-layout-edit" class="settings-layout-btn">âœ‹ RÃ©organiser librement</button>

                <button id="btn-settings-reset" class="settings-reset-btn">â†º Tout restaurer par dÃ©faut</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Confirm dialog (bottom-sheet) â”€â”€ -->
    <div id="confirm-overlay" class="confirm-overlay hidden">
        <div class="confirm-sheet">
            <div class="confirm-icon-big" id="confirm-icon">ğŸ—‘ï¸</div>
            <p class="confirm-title" id="confirm-title">Supprimer ce pin ?</p>
            <p class="confirm-sub"   id="confirm-sub">Cette action est irrÃ©versible</p>
            <div class="confirm-btns">
                <button class="confirm-btn confirm-btn-cancel" id="confirm-cancel">Annuler</button>
                <button class="confirm-btn confirm-btn-ok"     id="confirm-ok">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Scripts â”€â”€ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // â”€â”€ Enregistrement du Service Worker â”€â”€
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('[App] Service Worker enregistrÃ© :', reg.scope);
                    // Ã‰couter les messages du SW (ex: sync)
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data?.type === 'SYNC_PENDING_PINS') {
                            window.dispatchEvent(new CustomEvent('sw-sync-request'));
                        }
                    });
                })
                .catch(err => console.error('[App] SW erreur :', err));
        }

        // â”€â”€ Indicateur en ligne / hors ligne â”€â”€
        const offlineBanner = document.getElementById('offline-banner');
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineBanner.classList.add('hidden');
                // DÃ©clencher la synchronisation des pins en attente
                window.dispatchEvent(new CustomEvent('app-online'));
                // Demander un background sync au SW
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(sw => {
                        if ('sync' in sw) {
                            sw.sync.register('sync-pending-pins').catch(() => {});
                        }
                    });
                }
            } else {
                offlineBanner.classList.remove('hidden');
            }
        }
        window.addEventListener('offline', updateOnlineStatus);
        window.addEventListener('online', updateOnlineStatus);
        updateOnlineStatus();
    </script>

    <script type="module" src="js/app.js"></script>
</body>
</html>
